#!/usr/bin/env python3
"""
–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from modules.knowledge_base import KnowledgeBase
import hashlib

def test_duplicate_prevention():
    print("üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    kb = KnowledgeBase()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_doc_id = "test_duplicate_doc_001"
    test_content = "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è"
    test_metadata = {
        "source": "test_source.pdf",
        "type": "test_document"
    }
    
    print(f"üìÑ –¢–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç ID: {test_doc_id}")
    print(f"üìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ: {test_content}")
    print()
    
    # –¢–µ—Å—Ç 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    print("üß™ –¢–ï–°–¢ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞")
    print("-" * 40)
    
    result1 = kb.add_document(test_doc_id, test_content, test_metadata)
    print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {result1}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω
    exists_after_add = kb.document_exists(test_doc_id)
    print(f"üìã –î–æ–∫—É–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: {exists_after_add}")
    print()
    
    # –¢–µ—Å—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—Ç –∂–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ
    print("üß™ –¢–ï–°–¢ 2: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç")
    print("-" * 40)
    
    result2 = kb.add_document(test_doc_id, test_content, test_metadata)
    print(f"‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–∞: {result2}")
    print("üìå –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: False (–¥—É–±–ª–∏–∫–∞—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω)")
    print()
    
    # –¢–µ—Å—Ç 3: –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–º –∂–µ ID, –Ω–æ –¥—Ä—É–≥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
    print("üß™ –¢–ï–°–¢ 3: –¢–æ—Ç –∂–µ ID, –¥—Ä—É–≥–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ")
    print("-" * 40)
    
    different_content = "–≠—Ç–æ –¥—Ä—É–≥–æ–π –¥–æ–∫—É–º–µ–Ω—Ç —Å —Ç–µ–º –∂–µ ID"
    result3 = kb.add_document(test_doc_id, different_content, test_metadata)
    print(f"‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º: {result3}")
    print("üìå –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: False (ID —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)")
    print()
    
    # –¢–µ—Å—Ç 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID
    print("üß™ –¢–ï–°–¢ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID")
    print("-" * 40)
    
    unique_doc_id = "test_unique_doc_002"
    result4 = kb.add_document(unique_doc_id, different_content, test_metadata)
    print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {result4}")
    print()
    
    # –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    print("üß™ –¢–ï–°–¢ 5: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π")
    print("-" * 40)
    
    stats = kb.get_collection_stats()
    total_docs = stats.get('total_documents', 0)
    print(f"üìä –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {total_docs}")
    print()
    
    # –¢–µ—Å—Ç 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∏—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    print("üß™ –¢–ï–°–¢ 6: –ü–æ–∏—Å–∫ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print("-" * 40)
    
    search_results = kb.search_relevant_docs("—Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç", n_results=5)
    print(f"üîç –ù–∞–π–¥–µ–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É '—Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç': {len(search_results)}")
    
    for i, result in enumerate(search_results, 1):
        metadata = result.get('metadata', {})
        doc_id = metadata.get('doc_id', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        distance = result.get('distance', 0)
        print(f"  {i}. ID: {doc_id}, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {1-distance:.3f}")
    print()
    
    # –û—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
    print("üßπ –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
    print("-" * 40)
    
    cleanup1 = kb.delete_document(test_doc_id)
    cleanup2 = kb.delete_document(unique_doc_id)
    print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ {test_doc_id}: {cleanup1}")
    print(f"üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ {unique_doc_id}: {cleanup2}")
    print()
    
    # –ò—Ç–æ–≥–æ–≤—ã–π –≤—ã–≤–æ–¥
    print("üìã –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø")
    print("=" * 60)
    print("‚úÖ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:")
    print("   ‚Ä¢ –ù–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ")
    print("   ‚Ä¢ –î—É–±–ª–∏–∫–∞—Ç—ã –ø–æ ID –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è")
    print("   ‚Ä¢ –ü–æ–∏—Å–∫ –Ω–∞—Ö–æ–¥–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã")
    print("   ‚Ä¢ –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print()
    print("üîß –ú–ï–•–ê–ù–ò–ó–ú –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–Ø –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø:")
    print("   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É ID")
    print("   ‚Ä¢ –ö–∞–∂–¥—ã–π –±–ª–æ–∫ —Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä")
    print("   ‚Ä¢ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≥–æ –∂–µ ID –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è")
    print("   ‚Ä¢ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è")

if __name__ == "__main__":
    test_duplicate_prevention() 